<!--\n  Enhanced Legal AI Demo - Complete Integration\n  Features: Multi-protocol Upload → AI Analysis → Vector Search → Chat Interface\n  YoRHa UI with gaming aesthetics for legal professionals\n-->\n\n<script lang=\"ts\">\n  import { onMount } from 'svelte';\n  import { writable } from 'svelte/store';\n  import { documentProcessor } from '$lib/services/enhanced-document-processor';\n  import { semanticPipeline } from '$lib/ai/semantic-analysis-pipeline';\n  import { createRagStreamStore } from '$lib/ai/ragStreamClient';\n  import { yorhaTracker, userDashboard } from '$lib/yorha/user-activity-tracker';\n\n  // Component state\n  let selectedFile: File | null = null;\n  let uploading = false;\n  let processing = false;\n  let chatMessage = '';\n  let uploadProgress = 0;\n  let selectedProtocol: 'rest' | 'grpc' | 'quic' = 'rest';\n  \n  // AI Chat integration\n  const ragStore = createRagStreamStore({\n    maxRetries: 3,\n    summarization: { localOnMissing: true, maxSentences: 3 },\n    batching: { enabled: true, adaptive: true }\n  });\n  \n  // Reactive stores\n  const systemStatus = writable({\n    database: 'checking...',\n    ai: 'checking...',\n    storage: 'checking...',\n    overall: 'initializing'\n  });\n  \n  const processingResults = writable(null);\n  const chatHistory = writable([]);\n  \n  // Initialize the complete system\n  onMount(async () => {\n    console.log('🚀 Initializing Enhanced Legal AI Demo...');\n    \n    try {\n      // Initialize YoRHa user tracking\n      await yorhaTracker.initialize('demo_user_001');\n      \n      // Initialize AI pipeline\n      await semanticPipeline.initialize();\n      \n      // Check system status\n      await checkSystemHealth();\n      \n      console.log('✅ Enhanced Legal AI Demo initialized');\n    } catch (error) {\n      console.error('❌ Demo initialization failed:', error);\n    }\n  });\n  \n  // System health check\n  async function checkSystemHealth() {\n    try {\n      const response = await fetch('/api/comprehensive-integration');\n      const status = await response.json();\n      \n      systemStatus.set({\n        database: status.components.database.postgresql,\n        ai: status.components.ai.ollama,\n        storage: status.components.database.minio,\n        overall: status.status\n      });\n    } catch (error) {\n      console.error('Health check failed:', error);\n    }\n  }\n  \n  // Enhanced document upload with protocol selection\n  async function handleDocumentUpload() {\n    if (!selectedFile) return;\n    \n    uploading = true;\n    uploadProgress = 0;\n    \n    try {\n      console.log(`📄 Uploading via ${selectedProtocol.toUpperCase()} protocol...`);\n      \n      // Track upload activity\n      await yorhaTracker.trackActivity({\n        type: 'document_upload',\n        entityId: crypto.randomUUID(),\n        metadata: {\n          fileName: selectedFile.name,\n          fileSize: selectedFile.size,\n          protocol: selectedProtocol\n        },\n        outcome: 'success'\n      });\n      \n      // Process document with selected protocol\n      const jobId = await documentProcessor.processDocument(\n        selectedFile,\n        {\n          documentType: 'legal_brief',\n          caseId: 'demo_case_001',\n          tags: ['demo', 'ai_analysis'],\n          confidentiality: 'confidential',\n          createdBy: 'demo_user_001'\n        },\n        {\n          protocol: selectedProtocol,\n          enableAIAnalysis: true,\n          enableVectorSearch: true,\n          enableGraphStorage: true,\n          priority: 'high'\n        }\n      );\n      \n      // Monitor processing progress\n      const progressInterval = setInterval(() => {\n        documentProcessor.getProcessingStats().subscribe(stats => {\n          const job = stats.find((j: any) => j.id === jobId);\n          if (job) {\n            uploadProgress = job.progress;\n            \n            if (job.status === 'completed') {\n              clearInterval(progressInterval);\n              processingResults.set(job);\n              uploading = false;\n              \n              // Trigger semantic analysis display\n              displayAnalysisResults(job);\n            }\n          }\n        });\n      }, 500);\n      \n    } catch (error) {\n      console.error('Upload failed:', error);\n      uploading = false;\n    }\n  }\n  \n  // Display AI analysis results\n  function displayAnalysisResults(job: any) {\n    if (job.aiAnalysis) {\n      console.log('🤖 AI Analysis completed:', job.aiAnalysis);\n      \n      // Auto-populate chat with analysis summary\n      const analysisPrompt = `Please summarize the key legal issues and recommendations for the document \"${job.originalName}\" that was just analyzed.`;\n      handleAIChat(analysisPrompt, true);\n    }\n  }\n  \n  // Enhanced AI chat with intent detection\n  async function handleAIChat(message?: string, autoGenerated = false) {\n    const query = message || chatMessage;\n    if (!query.trim()) return;\n    \n    processing = true;\n    \n    try {\n      // Track AI interaction\n      await yorhaTracker.trackAIInteraction(\n        query,\n        'Generating response...',\n        'legal_advice'\n      );\n      \n      // Add user message to chat\n      if (!autoGenerated) {\n        chatHistory.update(history => [\n          ...history,\n          { role: 'user', content: query, timestamp: new Date() }\n        ]);\n      }\n      \n      // Start RAG streaming\n      await ragStore.start({\n        query,\n        contextIds: ['demo_case_001'],\n        intent: 'legal_analysis',\n        model: 'gemma3-legal'\n      });\n      \n      // Clear input\n      if (!autoGenerated) {\n        chatMessage = '';\n      }\n      \n    } catch (error) {\n      console.error('AI chat failed:', error);\n    } finally {\n      processing = false;\n    }\n  }\n  \n  // Handle RAG response completion\n  $: if ($ragStore.status === 'done' && $ragStore.tokens.length > 0) {\n    const response = $ragStore.tokens.join('');\n    const summary = $ragStore.summary || 'Response completed';\n    \n    chatHistory.update(history => [\n      ...history,\n      { \n        role: 'assistant', \n        content: response,\n        summary,\n        timestamp: new Date(),\n        sources: $ragStore.patches.length,\n        confidence: 0.9\n      }\n    ]);\n    \n    // Track completion\n    yorhaTracker.trackAIInteraction(\n      'Previous query',\n      response,\n      'response_generated'\n    );\n  }\n  \n  // File selection handler\n  function handleFileSelect(event: Event) {\n    const target = event.target as HTMLInputElement;\n    selectedFile = target.files?.[0] || null;\n  }\n  \n  // Protocol selection\n  function selectProtocol(protocol: 'rest' | 'grpc' | 'quic') {\n    selectedProtocol = protocol;\n  }\n  \n  // Run integration test\n  async function runIntegrationTest() {\n    try {\n      const response = await fetch('/api/comprehensive-integration', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          testType: 'full_workflow',\n          payload: { documentType: 'demo' }\n        })\n      });\n      \n      const results = await response.json();\n      console.log('🧪 Integration test results:', results);\n      \n      // Display test results in chat\n      chatHistory.update(history => [\n        ...history,\n        {\n          role: 'system',\n          content: `Integration test completed successfully! ✅\\n\\nWorkflow: ${results.workflow}\\nTotal time: ${results.totalTime}ms\\nSteps completed: ${results.steps.length}`,\n          timestamp: new Date()\n        }\n      ]);\n      \n    } catch (error) {\n      console.error('Integration test failed:', error);\n    }\n  }\n</script>\n\n<svelte:head>\n  <title>Enhanced Legal AI Platform - Complete Integration Demo</title>\n  <meta name=\"description\" content=\"Multi-protocol document processing with AI analysis and chat\">\n</svelte:head>\n\n<!-- YoRHa-style UI with gaming aesthetics -->\n<div class=\"yorha-container min-h-screen bg-black text-white font-mono\">\n  <!-- Header with system status -->\n  <header class=\"yorha-header border-b border-gray-700 p-4\">\n    <div class=\"flex items-center justify-between\">\n      <h1 class=\"text-2xl font-bold text-cyan-400\">\n        ◆ ENHANCED LEGAL AI PLATFORM ◆\n      </h1>\n      \n      <!-- System status indicators -->\n      <div class=\"flex gap-4 text-sm\">\n        <div class=\"status-indicator\">\n          <span class=\"text-gray-400\">DB:</span>\n          <span class=\"status-dot {$systemStatus.database === 'operational' ? 'bg-green-400' : 'bg-red-400'}\"></span>\n          <span class=\"{$systemStatus.database === 'operational' ? 'text-green-400' : 'text-red-400'}\">\n            {$systemStatus.database}\n          </span>\n        </div>\n        \n        <div class=\"status-indicator\">\n          <span class=\"text-gray-400\">AI:</span>\n          <span class=\"status-dot {$systemStatus.ai === 'operational' ? 'bg-green-400' : 'bg-red-400'}\"></span>\n          <span class=\"{$systemStatus.ai === 'operational' ? 'text-green-400' : 'text-red-400'}\">\n            {$systemStatus.ai}\n          </span>\n        </div>\n        \n        <div class=\"status-indicator\">\n          <span class=\"text-gray-400\">Storage:</span>\n          <span class=\"status-dot {$systemStatus.storage === 'operational' ? 'bg-green-400' : 'bg-red-400'}\"></span>\n          <span class=\"{$systemStatus.storage === 'operational' ? 'text-green-400' : 'text-red-400'}\">\n            {$systemStatus.storage}\n          </span>\n        </div>\n      </div>\n    </div>\n  </header>\n  \n  <!-- Main content grid -->\n  <main class=\"grid grid-cols-1 lg:grid-cols-3 gap-6 p-6 h-[calc(100vh-80px)]\">\n    <!-- Document Upload Panel -->\n    <section class=\"yorha-panel col-span-1\">\n      <h2 class=\"panel-title\">📄 DOCUMENT INGESTION</h2>\n      \n      <!-- Protocol selection -->\n      <div class=\"mb-4\">\n        <label class=\"block text-sm text-gray-400 mb-2\">Protocol Selection:</label>\n        <div class=\"flex gap-2\">\n          {#each ['rest', 'grpc', 'quic'] as protocol}\n            <button\n              class=\"protocol-btn {selectedProtocol === protocol ? 'active' : ''}\"\n              onclick={() => selectProtocol(protocol)}\n            >\n              {protocol.toUpperCase()}\n            </button>\n          {/each}\n        </div>\n      </div>\n      \n      <!-- File upload -->\n      <div class=\"mb-4\">\n        <label class=\"block text-sm text-gray-400 mb-2\">Select Legal Document:</label>\n        <input\n          type=\"file\"\n          accept=\".pdf,.doc,.docx,.txt\"\n          onchange={handleFileSelect}\n          class=\"file-input w-full\"\n        >\n      </div>\n      \n      <!-- Upload progress -->\n      {#if uploading}\n        <div class=\"mb-4\">\n          <div class=\"progress-bar bg-gray-700 rounded\">\n            <div \n              class=\"progress-fill bg-cyan-400 rounded transition-all duration-300\"\n              style=\"width: {uploadProgress}%\"\n            ></div>\n          </div>\n          <p class=\"text-sm text-gray-400 mt-1\">Processing: {uploadProgress.toFixed(1)}%</p>\n        </div>\n      {/if}\n      \n      <!-- Upload button -->\n      <button\n        class=\"action-btn w-full {uploading ? 'opacity-50 cursor-not-allowed' : ''}\"\n        onclick={handleDocumentUpload}\n        disabled={!selectedFile || uploading}\n      >\n        {uploading ? 'PROCESSING...' : 'UPLOAD & ANALYZE'}\n      </button>\n      \n      <!-- Integration test -->\n      <button\n        class=\"test-btn w-full mt-4\"\n        onclick={runIntegrationTest}\n      >\n        🧪 RUN INTEGRATION TEST\n      </button>\n      \n      <!-- Processing results -->\n      {#if $processingResults}\n        <div class=\"mt-6 p-4 bg-gray-800 rounded border border-cyan-400\">\n          <h3 class=\"text-sm font-bold text-cyan-400 mb-2\">ANALYSIS COMPLETE</h3>\n          <div class=\"text-xs space-y-1\">\n            <p><span class=\"text-gray-400\">Document:</span> {$processingResults.originalName}</p>\n            <p><span class=\"text-gray-400\">Status:</span> <span class=\"text-green-400\">{$processingResults.status}</span></p>\n            <p><span class=\"text-gray-400\">AI Analysis:</span> <span class=\"text-green-400\">Completed</span></p>\n            <p><span class=\"text-gray-400\">Vector Search:</span> <span class=\"text-green-400\">Indexed</span></p>\n            <p><span class=\"text-gray-400\">Graph Relations:</span> <span class=\"text-green-400\">Created</span></p>\n          </div>\n        </div>\n      {/if}\n    </section>\n    \n    <!-- AI Chat Interface -->\n    <section class=\"yorha-panel col-span-1 lg:col-span-2 flex flex-col\">\n      <h2 class=\"panel-title\">🤖 AI LEGAL ASSISTANT</h2>\n      \n      <!-- Chat history -->\n      <div class=\"chat-history flex-1 overflow-y-auto mb-4 space-y-4\">\n        {#each $chatHistory as message}\n          <div class=\"message {message.role}\">\n            <div class=\"message-header\">\n              <span class=\"role-badge {message.role}\">\n                {message.role === 'user' ? '👤 USER' : message.role === 'assistant' ? '🤖 AI' : '⚙️ SYSTEM'}\n              </span>\n              <span class=\"timestamp\">\n                {message.timestamp.toLocaleTimeString()}\n              </span>\n            </div>\n            <div class=\"message-content\">\n              {message.content}\n            </div>\n            {#if message.summary}\n              <div class=\"message-summary\">\n                <strong>Summary:</strong> {message.summary}\n              </div>\n            {/if}\n            {#if message.sources}\n              <div class=\"message-metadata\">\n                <span class=\"text-xs text-gray-400\">Sources: {message.sources} | Confidence: {(message.confidence * 100).toFixed(1)}%</span>\n              </div>\n            {/if}\n          </div>\n        {/each}\n        \n        <!-- RAG streaming status -->\n        {#if $ragStore.status !== 'idle'}\n          <div class=\"streaming-status\">\n            <div class=\"flex items-center gap-2\">\n              <div class=\"spinner\"></div>\n              <span class=\"text-sm text-cyan-400\">\n                Status: {$ragStore.status} | Tokens: {$ragStore.tokenCount}\n              </span>\n            </div>\n            \n            <!-- Live token stream -->\n            {#if $ragStore.tokens.length > 0}\n              <div class=\"live-response mt-2 p-2 bg-gray-800 rounded border border-cyan-400\">\n                <div class=\"text-xs text-gray-400 mb-1\">🔄 Live Response:</div>\n                <div class=\"text-sm\">\n                  {$ragStore.tokens.join('')}\n                  <span class=\"cursor animate-pulse\">█</span>\n                </div>\n              </div>\n            {/if}\n          </div>\n        {/if}\n      </div>\n      \n      <!-- Chat input -->\n      <div class=\"chat-input-container\">\n        <div class=\"flex gap-2\">\n          <input\n            type=\"text\"\n            bind:value={chatMessage}\n            placeholder=\"Ask about legal documents, cases, or analysis...\"\n            class=\"chat-input flex-1\"\n            onkeydown={(e) => e.key === 'Enter' && handleAIChat()}\n            disabled={processing}\n          >\n          <button\n            class=\"send-btn {processing ? 'opacity-50 cursor-not-allowed' : ''}\"\n            onclick={() => handleAIChat()}\n            disabled={processing || !chatMessage.trim()}\n          >\n            {processing ? '⏳' : '📤'}\n          </button>\n        </div>\n        \n        <!-- Quick actions -->\n        <div class=\"quick-actions mt-2 flex gap-2 text-xs\">\n          <button \n            class=\"quick-btn\"\n            onclick={() => handleAIChat('Analyze the uploaded document for potential legal risks')}\n          >\n            🔍 Risk Analysis\n          </button>\n          <button \n            class=\"quick-btn\"\n            onclick={() => handleAIChat('What are the key obligations in this document?')}\n          >\n            📋 Obligations\n          </button>\n          <button \n            class=\"quick-btn\"\n            onclick={() => handleAIChat('Find relevant legal precedents')}\n          >\n            ⚖️ Precedents\n          </button>\n        </div>\n      </div>\n    </section>\n  </main>\n  \n  <!-- User dashboard (YoRHa style) -->\n  {#if $userDashboard}\n    <aside class=\"yorha-sidebar fixed right-4 top-20 w-80 max-h-96 overflow-y-auto\">\n      <div class=\"yorha-panel p-4\">\n        <h3 class=\"text-sm font-bold text-cyan-400 mb-3\">👤 USER PROFILE</h3>\n        \n        <div class=\"space-y-2 text-xs\">\n          <div class=\"flex justify-between\">\n            <span class=\"text-gray-400\">Session Time:</span>\n            <span>{Math.round($userDashboard.todayStats.timeSpent / 60000)}m</span>\n          </div>\n          <div class=\"flex justify-between\">\n            <span class=\"text-gray-400\">Documents:</span>\n            <span class=\"text-green-400\">{$userDashboard.todayStats.documentsProcessed}</span>\n          </div>\n          <div class=\"flex justify-between\">\n            <span class=\"text-gray-400\">AI Queries:</span>\n            <span class=\"text-cyan-400\">{$userDashboard.todayStats.aiQueries}</span>\n          </div>\n          <div class=\"flex justify-between\">\n            <span class=\"text-gray-400\">Efficiency:</span>\n            <span class=\"text-yellow-400\">{$userDashboard.todayStats.efficiency}%</span>\n          </div>\n        </div>\n        \n        <!-- Recent activity -->\n        <div class=\"mt-4\">\n          <h4 class=\"text-xs font-bold text-gray-400 mb-2\">RECENT ACTIVITY</h4>\n          <div class=\"space-y-1\">\n            {#each $userDashboard.recentActivity.slice(0, 5) as activity}\n              <div class=\"text-xs flex justify-between\">\n                <span class=\"activity-type\">{activity.type}</span>\n                <span class=\"text-gray-500\">{activity.timestamp.toLocaleTimeString()}</span>\n              </div>\n            {/each}\n          </div>\n        </div>\n      </div>\n    </aside>\n  {/if}\n</div>\n\n<style>\n  .yorha-container {\n    background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);\n    font-family: 'Courier New', monospace;\n  }\n  \n  .yorha-header {\n    background: rgba(0, 255, 255, 0.1);\n    border-bottom: 2px solid #00ffff;\n    box-shadow: 0 2px 10px rgba(0, 255, 255, 0.3);\n  }\n  \n  .yorha-panel {\n    background: rgba(30, 30, 30, 0.8);\n    border: 1px solid #333;\n    border-radius: 4px;\n    padding: 1rem;\n    backdrop-filter: blur(10px);\n  }\n  \n  .panel-title {\n    font-size: 1rem;\n    font-weight: bold;\n    color: #00ffff;\n    margin-bottom: 1rem;\n    text-align: center;\n    border-bottom: 1px solid #333;\n    padding-bottom: 0.5rem;\n  }\n  \n  .protocol-btn {\n    padding: 0.5rem 1rem;\n    background: rgba(50, 50, 50, 0.5);\n    border: 1px solid #555;\n    color: #ccc;\n    border-radius: 4px;\n    cursor: pointer;\n    transition: all 0.3s ease;\n  }\n  \n  .protocol-btn:hover {\n    background: rgba(70, 70, 70, 0.5);\n    border-color: #777;\n  }\n  \n  .protocol-btn.active {\n    background: rgba(0, 255, 255, 0.2);\n    border-color: #00ffff;\n    color: #00ffff;\n  }\n  \n  .file-input {\n    padding: 0.75rem;\n    background: rgba(50, 50, 50, 0.5);\n    border: 1px solid #555;\n    border-radius: 4px;\n    color: #fff;\n  }\n  \n  .progress-bar {\n    height: 8px;\n    overflow: hidden;\n  }\n  \n  .progress-fill {\n    height: 100%;\n    background: linear-gradient(90deg, #00ffff 0%, #0080ff 100%);\n  }\n  \n  .action-btn {\n    padding: 1rem;\n    background: linear-gradient(135deg, #00ffff 0%, #0080ff 100%);\n    border: none;\n    border-radius: 4px;\n    color: #000;\n    font-weight: bold;\n    cursor: pointer;\n    transition: all 0.3s ease;\n  }\n  \n  .action-btn:hover:not(:disabled) {\n    transform: translateY(-2px);\n    box-shadow: 0 4px 15px rgba(0, 255, 255, 0.4);\n  }\n  \n  .test-btn {\n    padding: 0.75rem;\n    background: rgba(255, 165, 0, 0.2);\n    border: 1px solid #ffa500;\n    border-radius: 4px;\n    color: #ffa500;\n    cursor: pointer;\n    transition: all 0.3s ease;\n  }\n  \n  .test-btn:hover {\n    background: rgba(255, 165, 0, 0.3);\n  }\n  \n  .chat-history {\n    max-height: 500px;\n  }\n  \n  .message {\n    padding: 1rem;\n    border-radius: 4px;\n    border-left: 3px solid;\n  }\n  \n  .message.user {\n    background: rgba(0, 100, 200, 0.1);\n    border-left-color: #0064c8;\n  }\n  \n  .message.assistant {\n    background: rgba(0, 255, 100, 0.1);\n    border-left-color: #00ff64;\n  }\n  \n  .message.system {\n    background: rgba(255, 165, 0, 0.1);\n    border-left-color: #ffa500;\n  }\n  \n  .message-header {\n    display: flex;\n    justify-content: space-between;\n    margin-bottom: 0.5rem;\n    font-size: 0.75rem;\n  }\n  \n  .role-badge {\n    font-weight: bold;\n  }\n  \n  .role-badge.user { color: #0064c8; }\n  .role-badge.assistant { color: #00ff64; }\n  .role-badge.system { color: #ffa500; }\n  \n  .timestamp {\n    color: #666;\n  }\n  \n  .message-content {\n    line-height: 1.5;\n    white-space: pre-wrap;\n  }\n  \n  .message-summary {\n    margin-top: 0.5rem;\n    padding: 0.5rem;\n    background: rgba(255, 255, 255, 0.05);\n    border-radius: 4px;\n    font-size: 0.875rem;\n  }\n  \n  .message-metadata {\n    margin-top: 0.5rem;\n  }\n  \n  .chat-input {\n    padding: 0.75rem;\n    background: rgba(50, 50, 50, 0.5);\n    border: 1px solid #555;\n    border-radius: 4px;\n    color: #fff;\n  }\n  \n  .send-btn {\n    padding: 0.75rem 1rem;\n    background: rgba(0, 255, 255, 0.2);\n    border: 1px solid #00ffff;\n    border-radius: 4px;\n    color: #00ffff;\n    cursor: pointer;\n  }\n  \n  .quick-actions {\n    display: flex;\n    gap: 0.5rem;\n    flex-wrap: wrap;\n  }\n  \n  .quick-btn {\n    padding: 0.25rem 0.5rem;\n    background: rgba(100, 100, 100, 0.2);\n    border: 1px solid #666;\n    border-radius: 4px;\n    color: #ccc;\n    cursor: pointer;\n    font-size: 0.75rem;\n  }\n  \n  .quick-btn:hover {\n    background: rgba(150, 150, 150, 0.2);\n    border-color: #999;\n  }\n  \n  .status-indicator {\n    display: flex;\n    align-items: center;\n    gap: 0.5rem;\n  }\n  \n  .status-dot {\n    width: 8px;\n    height: 8px;\n    border-radius: 50%;\n    display: inline-block;\n  }\n  \n  .streaming-status {\n    padding: 1rem;\n    background: rgba(0, 255, 255, 0.1);\n    border: 1px solid #00ffff;\n    border-radius: 4px;\n  }\n  \n  .spinner {\n    width: 16px;\n    height: 16px;\n    border: 2px solid #333;\n    border-top: 2px solid #00ffff;\n    border-radius: 50%;\n    animation: spin 1s linear infinite;\n  }\n  \n  @keyframes spin {\n    0% { transform: rotate(0deg); }\n    100% { transform: rotate(360deg); }\n  }\n  \n  .cursor {\n    color: #00ffff;\n  }\n  \n  .yorha-sidebar {\n    z-index: 50;\n  }\n  \n  .activity-type {\n    text-transform: uppercase;\n    font-size: 0.7rem;\n  }\n</style>"