<script lang="ts">
  import { onMount } from 'svelte';
  import { writable } from 'svelte/store';
  import { useMachine } from '@xstate/svelte';
  import { agentShellMachine } from '$lib/machines/agentShellMachine';
  import { io } from 'socket.io-client';
  import Loki from 'lokijs';
  import Fuse from 'fuse.js';

  // State machine for agent activity
  const { state, send } = useMachine(agentShellMachine);

  // Local cache for job state
  const db = new Loki('agentCache');
  const jobs = db.addCollection('jobs');
  const jobStore = writable([]);

  // Fuzzy search setup
  let fuse;
  let searchResults = [];

  // WebSocket for real-time updates
  let socket;
  onMount(() => {
    socket = io('/api/ws');
    socket.on('agent-update', (data) => {
      jobs.insert(data);
      jobStore.set(jobs.find());
      if (fuse) fuse.setCollection(jobs.find());
    });
    // Initialize Fuse.js
    fuse = new Fuse(jobs.find(), { keys: ['description', 'status'] });
  });

  function searchJobs(query: string) {
    searchResults = fuse.search(query).map(r => r.item);
  }

  function acceptPatch(jobId: string) {
    send({ type: 'ACCEPT_PATCH', jobId });
  }

  function rateSuggestion(jobId: string, rating: number) {
    send({ type: 'RATE_SUGGESTION', jobId, rating });
  }
</script>

<div class="vector-demo">
<div class="vector-intelligence-demo">
  <h2>Agentic Legal AI Demo</h2>
  <input placeholder="Search jobs..." on:input={(e) => searchJobs(e.target.value)} />
  <ul>
    {#each $jobStore as job}
      <li>
        <strong>{job.description}</strong> ‚Äî {job.status}
        <button on:click={() => acceptPatch(job.id)}>Accept Patch</button>
        <button on:click={() => rateSuggestion(job.id, 5)}>üëç</button>
        <button on:click={() => rateSuggestion(job.id, 1)}>üëé</button>
      </li>
    {/each}
  </ul>
  <canvas id="webgpu-canvas" width="800" height="400"></canvas>
  <div>
    <h3>Search Results</h3>
    <ul>
      {#each searchResults as result}
        <li>{result.description} ‚Äî {result.status}</li>
      {/each}
    </ul>
  </div>
</div>
</div>

<style>
.vector-intelligence-demo {
  max-width: 800px;
  margin: 2rem auto;
  padding: 1rem;
  border: 1px solid #ccc;
  border-radius: 8px;
}
input {
  width: 70%;
  padding: 0.5rem;
  margin-right: 0.5rem;
}
button {
  padding: 0.5rem 1rem;
}
ul {
  margin-top: 1rem;
}
canvas {
  margin-top: 2rem;
  border: 1px solid #aaa;
  border-radius: 4px;
}
</style>
