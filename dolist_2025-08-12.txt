Legal AI — Action Plan (2025-08-12)

Checklist
- Fix MCP server: use input for Ollama embeddings; decouple chat vs embed model
- Add metadata-aware indexing and summarization endpoints
- Make file watching optional; don’t require chokidar when off
- Quiet OpenAI errors and cases/evidence SQL issues
- Short-circuit pgvector queries when embedding is empty

Actions Taken
- MCP server (mcp/custom-context7-server.js)
  - Decoupled models: OLLAMA_MODEL=gemma3-legal (chat), OLLAMA_EMBED_MODEL=nomic-embed-text (embeddings)
  - Embeddings payload fixed to { input }; supports {embedding}, {embeddings}, OpenAI-like {data:[{embedding}]}
  - Added endpoints: POST /api/index, POST /api/semantic-search, POST /api/summarize
  - Optional file watcher: WATCH_FILES=true indexes .md/.txt under CONTENT_DIR; chokidar loaded only when enabled
- Vector search hardening (sveltekit-frontend/src/lib/server/search/vector-search.ts)
  - OpenAI fallback only if OPENAI_API_KEY is set
  - Cases/Evidence pgvector: skip when query embedding empty; avoid [] SQL params
  - Removed selecting non-existent cases.metadata
  - Restored Loki init block

Usage
- Start MCP server (port 3000)
  - Endpoints: /api/index, /api/semantic-search, /api/summarize
- Configure
  - OLLAMA_URL=http://localhost:11434
  - OLLAMA_EMBED_MODEL=nomic-embed-text
  - PGVECTOR connection: PG_VECTOR_URL or DATABASE_URL
  - Optional: WATCH_FILES=true, CONTENT_DIR=./docs
- Index
  - POST /api/index with documents: [{ title, content, metadata }]
- Search
  - POST /api/semantic-search with { query, k }

Quick Fixes Applied
- Disabled OpenAI fallback unless key exists (no more ‘key not configured’ noise)
- Guarded pgvector queries against empty vectors; removed bad metadata column
- Loki database initialization fixed

Unblock Vector Hits — Next Steps
- Ensure working embeddings
  - EMBED_MODEL_LIST="nomic-embed-text,all-minilm,bge-small"
  - Pull models in Ollama; verify /api/embeddings returns non-empty arrays
  - CPU/Xenova fallback already wired (ensure EMBEDDING_DIMENSIONS matches DB, default 384)
- EnhancedAIPipeline
  - Fix Postgres credentials or disable pipeline to reduce noise
- Cases/Evidence schema
  - Align column names if you want those results as well

Notes
- Vite terser warning: remove terserOptions or set build.minify="terser" if needed
- Svelte event directive deprecations can be updated later (oninput/onchange/etc.)

Completion Summary
- MCP server supports local nomic-embed with metadata-aware indexer and summarizer; watcher optional
- SvelteKit vector search won’t log OpenAI key errors or run pgvector with empty vectors
- Next: confirm embeddings return non-empty vectors (Ollama or Xenova) and retest vector search
